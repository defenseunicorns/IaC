kind: ZarfPackageConfig
metadata:
  name: "terraform"
  description: "Run terraform/terragrunt code"

variables:
  - name: TF_VAR_region
    description: "target AWS region"
    default: "us-east-2"
  - name: TF_VAR_region2
    description: "RDS backup target AWS region"
    default: "us-east-1"
  - name: TF_VAR_aws_account
    description: "target AWS account"
    default: "100008675309"
  - name: TF_VAR_aws_profile
    description: "local AWS profile to be used for deployment"
    default: "example-aws-profile"
  - name: TF_VAR_aws_admin_1_username
    default: "Bob.Marley"
  - name: TF_VAR_aws_admin_2_username
    default: "Jane.Doe"
  - name: TF_VAR_vpc_cidr
    default: "10.10.10.0/16"
  - name: TF_VAR_vpc_name
    default: "my-vpc"
  - name: TF_VAR_db_subnets
    default: '"10.10.17.0/24","10.10.18.0/24","10.10.19.0/24"'
  - name: TF_VAR_eks_cluster_name
    default: "my-eks"
  - name: TF_VAR_eks_cluster_version
    default: "1.23"
  - name: TF_VAR_bastion_name
    default: "my-bastion"
  - name: TF_VAR_bastion_ami_id
    default: "ami-000d4884381edb14c"
  - name: TF_VAR_bastion_ssh_user
    default: "ec2-user"
  - name: TF_VAR_keycloak_enabled
    default: "true"
  - name: TF_VAR_keycloak_db_password
    default: "my-password"
  - name: TF_VAR_kc_db_engine_version
    default: "14.1"
  - name: TF_VAR_kc_db_family
    default: "postgres14"
  - name: TF_VAR_kc_db_major_engine_version
    default: "14"
  - name: TF_VAR_kc_db_allocated_storage
    default: 20.0
  - name: TF_VAR_kc_db_max_allocated_storage
    default: 100.0
  - name: TF_VAR_kc_db_instance_class
    default: "db.t4g.large"

components:
  - name: download-dependencies
    required: true
    actions:
      onDeploy:
        after:
          - retry: true
            cmd: "rm -f terraform"
          - retry: true
            cmd: "./zarf tools archiver decompress tmp/terraform_###ZARF_PKG_VAR_TF_VERSION###_###ZARF_PKG_VAR_ARCH_NAME###_###ZARF_PKG_VAR_ARCH_PROC###.zip ."
          # - "./zarf tools archiver decompress tmp/awscliv2.zip ."
          # - "rm -rf tmp/"
    files:
      # terraform binary
      - source: https://releases.hashicorp.com/terraform/###ZARF_PKG_VAR_TF_VERSION###/terraform_###ZARF_PKG_VAR_TF_VERSION###_###ZARF_PKG_VAR_ARCH_NAME###_###ZARF_PKG_VAR_ARCH_PROC###.zip
        target: tmp/terraform_###ZARF_PKG_VAR_TF_VERSION###_###ZARF_PKG_VAR_ARCH_NAME###_###ZARF_PKG_VAR_ARCH_PROC###.zip
      # aws cli binary
      # - source: https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip
      #   target: tmp/awscliv2.zip

  - name: terraform-init
    description: Terraform init using zarf actions
    required: true
    actions:
      onCreate:
        before:
          - retry: true
            cmd:  "cd ###ZARF_PKG_VAR_TF_ENV_DIR### && terraform init -backend=false"
          - retry: true
            cmd: "cd ###ZARF_PKG_VAR_TF_ENV_STATE_DIR### && terraform init -backend=false"
    files:
      - source: "###ZARF_PKG_VAR_TF_ENV_DIR###"
        target: "tmp/###ZARF_PKG_VAR_TF_ENV###"
      - source: "###ZARF_PKG_VAR_TF_ENV_STATE_DIR###"
        target: "tmp/###ZARF_PKG_VAR_TF_ENV_STATE###"
      - source: "###ZARF_PKG_VAR_TF_MODULES_DIR###"
        target: "tmp/modules"
  
  - name: update-tf-vars
    required: true
    actions:
      onDeploy:
        before:
          - cmd: env
        after:
          - cmd: rm tmp/###ZARF_PKG_VAR_TF_ENV###/terraform.tfvars.tmpl
    files:
      - source: "###ZARF_PKG_VAR_TF_ENV_STATE_DIR###/main.tf"
        target: tmp/###ZARF_PKG_VAR_TF_ENV_STATE###/main.tf
      - source: "###ZARF_PKG_VAR_TF_ENV_DIR###/terraform.tfvars.tmpl"
        target: tmp/###ZARF_PKG_VAR_TF_ENV###/terraform.tfvars

  - name: terraform-s3-bucket
    actions:
      onDeploy:
        defaults:
          maxTotalSeconds: 300
          maxRetries: 3
          dir: "tmp/###ZARF_PKG_VAR_TF_ENV_STATE###"
        before:
          - cmd: "terraform apply -auto-approve"
          - cmd: "terraform output -raw tfstate_bucket_id"
            setVariable: BUCKET_ID 
        onSuccess:
          - cmd: "mv backend.example backend.tf && sed -i '' 's|bucket.*|bucket         = \"'$BUCKET_ID'\"|' backend.tf"
            cmd: "terraform init -migrate-state -force-copy"

  - name: terraform-apply-bootstrap
    actions:
        onDeploy:
          defaults:
            maxTotalSeconds: 300
            maxRetries: 3
            dir: tmp/###ZARF_PKG_VAR_TF_ENV###
          before:
            - cmd: "terraform output -raw tfstate_bucket_id"
              dir: tmp/###ZARF_PKG_VAR_TF_ENV_STATE###
              setVariable: BUCKET_ID 
          onSuccess:
            - cmd: "mv backend.example backend.tf && sed -i '' 's|bucket.*|bucket         = \"'$BUCKET_ID'\"|' backend.tf"
            - cmd: "aws s3 cp backend.tf s3://$BUCKET_ID/backend.tf"
            - cmd: "terraform init -migrate-state -force-copy && terraform apply -auto-approve"

  - name: terraform-apply-day2
    actions:
      onDeploy:
        before:
          - retry: true  
            cmd: "cd tmp/###ZARF_PKG_VAR_TF_ENV### && aws s3 cp s3://my-tfstate-backend20221221075202171300000001/backend.tf backend.tf && terraform init && terraform apply -target=module.vpc -auto-approve"

  - name: terraform-destroy
    actions:
      onDeploy:
        before:
          - retry: true
            cmd: "cd tmp/###ZARF_PKG_VAR_TF_ENV### && aws s3 cp s3://my-tfstate-backend20221221075202171300000001/backend.tf backend.tf && terraform init && terraform apply -destroy -auto-approve"
